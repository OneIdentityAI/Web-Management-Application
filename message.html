<!doctype html>
<html lang="en">
  <head>
    <link rel="icon" type="image/png" href="images/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="images/favicon/favicon-16x16.png" sizes="16x16" />
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,400,600,700,800,900" rel="stylesheet"> 
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <!-- Slick -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css"/>
    <!-- Animations -->
    <link href="css/animate.css" rel="stylesheet">
    <!-- Main CSS -->
    <link href="css/style.css" rel="stylesheet">
    <title>One Identity - Message</title>
    <style>
        table, th, td 
        {
            white-space: nowrap;
        }
    </style>
  </head>
  <body class="page page-profile">
    <div id="loading-ajax" style="display:none"></div>
    <nav id="main-nav" class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand logo" href="/endpoint_did.html"><img src="images/one-identity-logo-developers-portal.png"></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link" href="/main.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/schema.html">Schema</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/credential.html">Credential</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" style="color:#008ED1" href="/message.html">Message</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/did.html">Did</a>
            </li>
			      <li class="nav-item">
              <a class="nav-link" href="/docs.html">Docs</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="javascript:signOut()">Logout</a>
            </li>
          </ul>
        </div>
      </div>
    </nav><!-- #main-nav -->
    <div class="notification-bar mt-4">
      <div class="container">
        <img src="images/icon-info-grey.png" style="width: 18px;"><strong class="ml-1 mr-4"></strong> <span id="text_endpoint_did"></span>
      </div>
    </div>
    <div id="section-my-profile" class="section pt-5 pb-5">
      <div class="container">
        <div class="row">
          <div class="col-12">
            <h2 class="font-weight-bold">Message List</h2>
            <p class="mb-2">List of incoming message</p>
          </div>
        </div>
        <div class="row mt-5">
          <div class="col-12 mt-4">
            <div class="table-responsive mb-5">
              <table class="table" id="table_data">
                <thead>
                  <tr>
                    <th>Detail</th>
                    <th>Type</th>
                    <th>Operation</th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- #section-my-profile -->
    <div id="footer-2" class="pt-5 pb-5">
      <div class="container">
        <div class="row"> 
          <div class="col-12 col-lg-3 text-center text-lg-left">
            <a class="navbar-brand logo" href="#"><img style="max-width: 250px;" class="img-responsive" src="images/one-identity-logo-developers-portal.png"></a>
          </div>
          <div class="col-12 col-lg-4 text-center text-lg-left mt-4 mb-4 mt-lg-0 mb-lg-0 align-self-center">
            Copyright 2019 One Identity, all rights reserved
          </div>
          <div class="col-12 col-lg-5 social-media text-center text-lg-right align-self-center">
            <a href="https://t.me/oneidai"><img src="images/icon-telegram.png"></a>
            <a href="https://github.com/OneIdentityAI"><img src="images/icon-github.png"></a>
            <a href="#"><img src="images/icon-medium.png"></a>
          </div>
        </div>
      </div>
    </div>
    
    <!-- The Modal -->
    <div class="modal" id="modal_select_did">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
          
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title">Select available DID</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body">
                <div class="col-12 mt-4">
                    <div class="table-responsive mb-5">
                      <table class="table" id="table_data_did">
                        <thead>
                          <tr>
                            <th>Detail</th>
                            <th>Used</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    </div>
                  </div>
            </div>
            <!-- Modal footer -->
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
    <script src="js/waypoints.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@8"></script>
    <script src="js/config.js"></script>
    <script>
      var dataArray = [];
      var connectionArray = [];
      var proofArray = [];

      if(localStorage.getItem("sign_in_id") !== null && localStorage.getItem("sign_in_id") !== "" &&
          localStorage.getItem("token") !== null && localStorage.getItem("token") !== "")
        {
          $("#text_endpoint_did").text("Endpoint DID : " + localStorage.getItem("endpoint_did"));
          listConnection();
        }
        else
        {
          window.location.href = "/index.html";
        }

        function listProof()
        {
          $("#loading-ajax").show();
          $.ajax({
            type: 'POST',
            url: listProofUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token")
            }),
						headers: {
							"Authorization": "Bearer " + apikey,
						},
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response);
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {
                for(var i = 0; i < response.data.length; i++)
                {
                  proofArray.push(response.data[i]);
                }

                listMessage();
              }
            }
          });
        }

        var responseData;
        function listMessage()
        {
          $("#loading-ajax").show();
          $.ajax({
            type: 'POST',
            url: listMessageUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token"),
              type:""
            }),
						headers: {
							"Authorization": "Bearer " + apikey,
						},
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response)
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {
                responseData = response;
                var table = $("#table_data tbody");
                table.empty();
                for(var i = 0; i < response.data.length; i++)
                {
                  var currentIndex = dataArray.length;
                  var datetime = new Date(response.data[i].created_at);
                  dformat = [datetime.getFullYear(), (datetime.getMonth()+1).padLeft(), datetime.getDate().padLeft()].join('-') +' ' +
                            [datetime.getHours().padLeft(),
                            datetime.getMinutes().padLeft(),
                            datetime.getSeconds().padLeft()].join(':');
                  if(response.data[i].type === "MSG_TYPE_CONN_REQUEST")
                  {
                    var userName = "";
                    var companyName = "";
                    var walletName = "";
                    userName = userName.trim() == ""?"Unknown":userName;
                    companyName = companyName == ""?"Unknown":companyName;
                    walletName = walletName == ""?"Unknown":walletName;
                    table.append(`<tr><td class="align-middle">` + userName + " from " + companyName + "<br/>Wallet Name: " + walletName + "<br/>Datetime: " + dformat + `</td><td class="align-middle">New Connection Request</td><td class="align-middle"><img title="View Message" src="images/buttons/view_message.png" style="width:60px;height:auto;margin-right:5px" onclick="viewGenericDetail(` + i + `)"/><img title="Accept Connection" src="images/buttons/accept_connection.png" style="width:60px;height:auto;margin-right:5px" onclick="acceptConnection('` + response.data[i].message_id + `')"/><img title="Delete Message" src="images/buttons/delete_message.png" style="width:60px;height:auto;margin-right:5px" onclick="deleteMessage('` + response.data[i].message_id + `')"/></td></tr>`);
                    dataArray.push(response.data[i].message);
                  }
                  else if(response.data[i].type === "MSG_TYPE_SECURE_SEND")
                  {                    
                    var firstName = "";
                    var lastName = "";
                    var companyName = "";
                    var walletName = "";
                    var index = -1
                    for(var j = 0; j < connectionArray.length; j++)
                    {
                      if(connectionArray[j].their_did == response.data[i].message.sender_did)
                      {
                        index = j;
                        for(var k = 0; k < proofArray.length; k++)
                        {
                          if(proofArray[k].proof_request.name == connectProfileExchange && proofArray[k].sender_did == connectionArray[j].their_did)
                          {
                            firstName = proofArray[k].proof_offer[0].attribute_value;
                            lastName = proofArray[k].proof_offer[1].attribute_value;
                            companyName = proofArray[k].proof_offer[2].attribute_value;
                            walletName = proofArray[k].proof_offer[3].attribute_value;
                          }
                        }
                      }
                    }

                    var userName = firstName + " " + lastName;
                    userName = userName.trim() == ""?"Unknown":userName;
                    companyName = companyName == ""?"Unknown":companyName;
                    walletName = walletName == ""?"Unknown":walletName;
                    table.append(`<tr><td class="align-middle">Message From:<br/>` + userName + " from " + companyName + "<br/>Wallet Name: " + walletName + "<br/>Message: " + response.data[i].message.message + "<br/>Datetime: " + dformat + `</td><td class="align-middle">Secure Chat Message</td><td class="align-middle"><img title="View Message" src="images/buttons/view_message.png" style="width:60px;height:auto;margin-right:5px" onclick="viewGenericDetail(` + currentIndex + `)"/><img title="Send Message" src="images/buttons/send_message.png" style="width:60px;height:auto;margin-right:5px" onclick="sendMessage('` + connectionArray[index].my_did + `')"/><img title="Delete Message" src="images/buttons/delete_message.png" style="width:60px;height:auto;margin-right:5px" onclick="deleteMessage('` + response.data[i].message_id + `')"/></td></tr>`);
                    dataArray.push(response.data[i].message);
                  }
                  else if(response.data[i].type === "MSG_TYPE_CREDENTIAL_REQUEST")
                  {
                    var firstName = "";
                    var lastName = "";
                    var companyName = "";
                    var walletName = "";
                    var index = -1
                    for(var j = 0; j < connectionArray.length; j++)
                    {
                      if(connectionArray[j].their_did == response.data[i].message.sender_did)
                      {
                        index = j;
                        for(var k = 0; k < proofArray.length; k++)
                        {
                          if(proofArray[k].proof_request.name == connectProfileExchange && proofArray[k].sender_did == connectionArray[j].their_did)
                          {
                            firstName = proofArray[k].proof_offer[0].attribute_value;
                            lastName = proofArray[k].proof_offer[1].attribute_value;
                            companyName = proofArray[k].proof_offer[2].attribute_value;
                            walletName = proofArray[k].proof_offer[3].attribute_value;
                          }
                        }
                      }
                    }

                    var userName = firstName + " " + lastName;
                    userName = userName.trim() == ""?"Unknown":userName;
                    companyName = companyName == ""?"Unknown":companyName;
                    walletName = walletName == ""?"Unknown":walletName;
                    table.append(`<tr><td class="align-middle">Message From:<br/>` + userName + " from " + companyName + "<br/>Wallet Name: " + walletName + "<br/>Datetime: " + dformat + `</td><td class="align-middle">New Credential Request<br/><b><a href="/main.html">Go to connection page to issue credential</a></b></td><td class="align-middle"><img title="Delete Message" src="images/buttons/delete_message.png" style="width:60px;height:auto;margin-right:5px" onclick="deleteMessage('` + response.data[i].message_id + `')"/></td></tr>`);
                    dataArray.push(response.data[i].message);
                  }
                  else if(response.data[i].type === "MSG_TYPE_PROOF_OFFER")
                  {
                    var firstName = "";
                    var lastName = "";
                    var companyName = "";
                    var walletName = "";
                    var index = -1
                    for(var j = 0; j < connectionArray.length; j++)
                    {
                      if(connectionArray[j].their_did == response.data[i].message.sender_did)
                      {
                        index = j;
                        for(var k = 0; k < proofArray.length; k++)
                        {
                          if(proofArray[k].proof_request.name == connectProfileExchange)
                          {
                            firstName = proofArray[k].proof_offer[0].attribute_value;
                            lastName = proofArray[k].proof_offer[1].attribute_value;
                            companyName = proofArray[k].proof_offer[2].attribute_value;
                            walletName = proofArray[k].proof_offer[3].attribute_value;
                          }
                        }
                      }
                    }

                    var userName = firstName + " " + lastName;
                    userName = userName.trim() == ""?"Unknown":userName;
                    companyName = companyName == ""?"Unknown":companyName;
                    walletName = walletName == ""?"Unknown":walletName;

                    table.append(`<tr><td class="align-middle">Message From:<br/>` + userName + " from " + companyName + "<br/>Wallet Name: " + walletName + "<br/>Datetime: " + dformat + `</td><td class="align-middle">New Proof Offer<br/><b><a href="/main.html">Go to connection page to verify and accept this proof offer</a></b></td><td class="align-middle"><img title="View Accepted Proof" src="images/buttons/view_accepted_proof.png" style="width:60px;height:auto;margin-right:5px" onclick="viewGenericDetail(` + currentIndex + `)"/><img title="Delete Message" src="images/buttons/delete_message.png" style="width:60px;height:auto;margin-right:5px" onclick="deleteMessage('` + response.data[i].message_id + `')"/></td></tr>`);
                    dataArray.push(response.data[i].message);
                  }
                  else if(response.data[i].type === "MSG_TYPE_PROOF_REQUEST")
                  {
                    var firstName = "";
                    var lastName = "";
                    var companyName = "";
                    var walletName = "";
                    var index = -1
                    for(var j = 0; j < connectionArray.length; j++)
                    {
                      if(connectionArray[j].their_did == response.data[i].message.sender_did)
                      {
                        index = j;
                        for(var k = 0; k < proofArray.length; k++)
                        {
                          if(proofArray[k].proof_request.name == connectProfileExchange)
                          {
                            firstName = proofArray[k].proof_offer[0].attribute_value;
                            lastName = proofArray[k].proof_offer[1].attribute_value;
                            companyName = proofArray[k].proof_offer[2].attribute_value;
                            walletName = proofArray[k].proof_offer[3].attribute_value;
                          }
                        }
                      }
                    }

                    var userName = firstName + " " + lastName;
                    userName = userName.trim() == ""?"Unknown":userName;
                    companyName = companyName == ""?"Unknown":companyName;
                    walletName = walletName == ""?"Unknown":walletName;

                    table.append(`<tr><td class="align-middle">Message From:<br/>` + userName + " from " + companyName + "<br/>Wallet Name: " + walletName + "<br/>Datetime: " + dformat + `</td><td class="align-middle">New Proof Request<br/><b><a href="/main.html">Go to connection page to create proof offer</a></b></td><td class="align-middle"><img title="View Proof Requet" src="images/buttons/view_accepted_proof.png" style="width:60px;height:auto;margin-right:5px" onclick="viewGenericDetail(` + currentIndex + `)"/><img title="Delete Message" src="images/buttons/delete_message.png" style="width:60px;height:auto;margin-right:5px" onclick="deleteMessage('` + response.data[i].message_id + `')"/></td></tr>`);
                    dataArray.push(response.data[i].message);
                  }
                }
              }
            }
          });
        }
        
        function sendMessage(did)
        {
          Swal.fire({
            title: 'Send Message',
            text: "Send an encrypted plain text message to this connection",
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Send'
          }).then((result) => {
            if (result.value) {
              $("#loading-ajax").show();
              $.ajax({
                type: 'POST',
                url: sendMessageUrl,
                contentType: "application/json",
                dataType: "json",
                processData: false,
                data:
                JSON.stringify({
                  token : localStorage.getItem("token") === null?"":localStorage.getItem("token"),
                  sender_did : did,
                  message_content : result.value
                }),
                headers: {
                  "Authorization": "Bearer " + apikey,
                },
                success: function(response)
                {
                  $("#loading-ajax").hide();
                  console.log(response)
                  var status = "";
                  var message = "";
                  var error = "";
                  if(response.hasOwnProperty("error"))
                    error = response.error;
                  if(error != "")
                  {
                    Swal.fire(
                      response.error.type,
                      response.error.message,
                      'error'
                    );
                    return;
                  }
                  if(response.hasOwnProperty("status"))
                    status = response.status;
                  if(response.hasOwnProperty("message"))
                    message = response.message;
                  if(status === "200")
                  {
                    Swal.fire(
                      'Message Sent!',
                      'Your message sent successfully',
                      'success'
                    )
                  }
                }
              });
            }
          })
        }

        function listConnection()
        {
          $("#loading-ajax").show();
          $.ajax({
            type: 'POST',
            url: listConnectionUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token")
            }),
						headers: {
							"Authorization": "Bearer " + apikey,
						},
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response)
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {
                connectionArray = [];
                messageArray = [];
                proofArray = [];
                for(var i = 0; i < response.data.length; i++)
                {
                  connectionArray.push(response.data[i]);
                }
                listProof()
              }
            }
          });
        }

        function acceptConnection(messageId)
        {
          listDid(messageId);
          $('#modal_select_did').modal('show');
        }

        function listDid(messageId)
        {
          $("#loading-ajax").show();
          $.ajax({
            type: 'POST',
            url: listDidUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token")
            }),
						headers: {
							"Authorization": "Bearer " + apikey,
						},
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response)
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {
                var table = $("#table_data_did tbody");
                table.empty();
                for(var i = 0; i < response.data.length; i++)
                {
                  var datetime = new Date(response.data[i].created_at);
                  dformat = [datetime.getFullYear(), (datetime.getMonth()+1).padLeft(), datetime.getDate().padLeft()].join('-') +' ' +
                            [datetime.getHours().padLeft(),
                            datetime.getMinutes().padLeft(),
                            datetime.getSeconds().padLeft()].join(':');
                  var isPairwised = response.data[i].is_pairwise == 0? "No":"Yes";
                  var did = response.data[i].did;
                  if(response.data[i].is_pairwise == 1)
                    did = "";
                  table.append(`<tr><td class="align-middle">` + response.data[i].name + `<br/>DID: `+ response.data[i].did + `<br/>Datetime: ` + dformat + `</td><<td class="align-middle">` + isPairwised + `</td><td class="align-middle"><button class="btn-blue" style="white-space: nowrap;text-align: center;" onclick="selectDid('` + did + `','` + messageId + `')" >Select</button></td></tr>`);
                }
              }
            }
          });
        }

        function acceptConnectionRequest(did, messageId)
        {
          if(did == "")
          {
              $("#loading-ajax").hide();
            Swal.fire(
                  'Invalid Action',
                  'Please select a DID which is not in used',
                  'error'
                );
                return;
          }
          $.ajax({
            type: 'POST',
            url: acceptConnectionRequestUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token"),
              sender_did : did,
              message_id: messageId
            }),
            headers: {
              "Authorization": "Bearer " + apikey,
            },
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response)
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {                
                createProofRequest(did);
                Swal.fire(
                  'Success',
                  'Connection request accepted',
                  'success'
                );
              }
            }
          });
        }

        function selectDid(did, messageId)
        {
          $("#loading-ajax").show();
          $('#modal_select_did').modal('hide');

          acceptConnectionRequest(did, messageId);
        }

        function viewGenericDetail(index)
        {
          var genericDetail;
          
          var datetime = new Date(responseData.data[index].created_at);
          dformat = [datetime.getFullYear(), (datetime.getMonth()+1).padLeft(), datetime.getDate().padLeft()].join('-') +' ' +
                          [datetime.getHours().padLeft(),
                          datetime.getMinutes().padLeft(),
                          datetime.getSeconds().padLeft()].join(':');
          if(responseData.data[index].type === "MSG_TYPE_CONN_REQUEST")
          {
            genericDetail = {
              "title":"New Connection Detail",
              "subtitle":"",
              "data":[
                {
                  "name":"Message Id",
                  "value":responseData.data[index].message_id
                },
                {
                  "name":"Message Type",
                  "value":"New Connection Request"
                },
                {
                  "name":"DID",
                  "value":responseData.data[index].message.did
                },
                {
                  "name":"Endpoint DID",
                  "value":responseData.data[index].message.endpoint_did
                },
                {
                  "name":"Endpoint Verkey",
                  "value":responseData.data[index].message.endpoint_verkey
                },
                {
                  "name":"Message Nonce",
                  "value":responseData.data[index].message.nonce
                },
                {
                  "name":"Datetime",
                  "value":dformat
                }
              ]
            }
          }
          else if(responseData.data[index].type === "MSG_TYPE_SECURE_SEND")
          {
            var firstName = "";
            var lastName = "";
            var companyName = "";
            var walletName = "";
            var indexProof = -1
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == responseData.data[index].message.sender_did)
              {
                indexProof = j;
                for(var k = 0; k < proofArray.length; k++)
                {
                  if(proofArray[k].proof_request.name == connectProfileExchange)
                  {
                    firstName = proofArray[k].proof_offer[0].attribute_value;
                    lastName = proofArray[k].proof_offer[1].attribute_value;
                    companyName = proofArray[k].proof_offer[2].attribute_value;
                    walletName = proofArray[k].proof_offer[3].attribute_value;
                  }
                }
              }
            }
            var userName = firstName + " " + lastName;
            userName = userName.trim() == ""?"Unknown":userName;
            companyName = companyName == ""?"Unknown":companyName;
            walletName = walletName == ""?"Unknown":walletName;
            genericDetail = {
              "title":"Scure Message Detail",
              "subtitle":"",
              "data":[
                {
                  "name":"Message Id",
                  "value":responseData.data[index].message_id
                },
                {
                  "name":"Message Type",
                  "value":"Secure Message"
                }
              ]
            }
            var senderDid = responseData.data[index].message.sender_did;
            var index = -1
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == senderDid)
                indexProof = j;
            }
            if(indexProof > -1)
            {
              genericDetail.data.push(
                  {
                    "name":"User Name",
                    "value": userName
                  });
              genericDetail.data.push(
                  {
                    "name":"Company Name",
                    "value": companyName
                  });
              genericDetail.data.push(
                  {
                    "name":"Wallet Name",
                    "value": walletName
                  });
              genericDetail.data.push(
                  {
                    "name":"Sender DID",
                    "value": responseData.data[index].message.sender_did
                  });
            }
            genericDetail.data.push(
                {
                  "name":"Message",
                  "value": responseData.data[index].message.message
                });
            genericDetail.data.push(
                {
                  "name":"Datetime",
                  "value":dformat
                });
          }
          else if(responseData.data[index].type === "MSG_TYPE_PROOF_OFFER")
          {
            var firstName = "";
            var lastName = "";
            var companyName = "";
            var walletName = "";
            var indexProof = -1
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == responseData.data[index].message.sender_did)
              {
                indexProof = j;
                for(var k = 0; k < proofArray.length; k++)
                {
                  if(proofArray[k].proof_request.name == connectProfileExchange)
                  {
                    firstName = proofArray[k].proof_offer[0].attribute_value;
                    lastName = proofArray[k].proof_offer[1].attribute_value;
                    companyName = proofArray[k].proof_offer[2].attribute_value;
                    walletName = proofArray[k].proof_offer[3].attribute_value;
                  }
                }
              }
            }
            var userName = firstName + " " + lastName;
            userName = userName.trim() == ""?"Unknown":userName;
            companyName = companyName == ""?"Unknown":companyName;
            walletName = walletName == ""?"Unknown":walletName;
            genericDetail = {
              "title":"Proof Offer Detail",
              "subtitle":"",
              "data":[
                {
                  "name":"Message Id",
                  "value":responseData.data[index].message_id
                },
                {
                  "name":"Message Type",
                  "value":"New Proof Offer"
                }
              ]
            }
            var senderDid = responseData.data[index].message.sender_did;
            var indexProof = -1
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == senderDid)
                indexProof = j;
            }
            if(indexProof > -1)
            {
              genericDetail.data.push(
                  {
                    "name":"User Name",
                    "value": userName
                  });
              genericDetail.data.push(
                  {
                    "name":"Company Name",
                    "value": companyName
                  });
              genericDetail.data.push(
                  {
                    "name":"Wallet Name",
                    "value": walletName
                  });
              genericDetail.data.push(
                  {
                    "name":"Sender DID",
                    "value": responseData.data[index].message.sender_did
                  });
            }
              genericDetail.data.push(
                  {
                    "name":"Proof Request Nonce",
                    "value": responseData.data[index].message.proof_request.nonce
                  });
              genericDetail.data.push(
                  {
                    "name":"Proof Request Name",
                    "value": responseData.data[index].message.proof_request.name
                  });
              genericDetail.data.push(
                  {
                    "name":"Proof Request Version",
                    "value": responseData.data[index].message.proof_request.version
                  });
            for(var i = 0; i < responseData.data[index].message.proof_offer.length; i++)
            {
              var finalName = responseData.data[index].message.proof_offer[i].attribute_name;
              if(responseData.data[index].message.proof_offer[i].attribute_schema_id != "")
                finalName += "    from " + responseData.data[index].message.proof_offer[i].attribute_schema_id.split(":")[2] + " (" + responseData.data[index].message.proof_offer[i].attribute_schema_id.split(":")[3] + ")"
              genericDetail.data.push(
                  {
                    "name":"Attribute: " + finalName,
                    "value": responseData.data[index].message.proof_offer[i].attribute_value
                  });
            }
            genericDetail.data.push(
                {
                  "name":"Datetime",
                  "value":dformat
                });
          }
          else if(responseData.data[index].type === "MSG_TYPE_PROOF_REQUEST")
          {
            var firstName = "";
            var lastName = "";
            var companyName = "";
            var walletName = "";
            var indexProof = -1
            console.log(responseData.data[index]);
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == responseData.data[index].message.sender_did)
              {
                indexProof = j;
                for(var k = 0; k < proofArray.length; k++)
                {
                  if(proofArray[k].proof_request.name == connectProfileExchange)
                  {
                    firstName = proofArray[k].proof_offer[0].attribute_value;
                    lastName = proofArray[k].proof_offer[1].attribute_value;
                    companyName = proofArray[k].proof_offer[2].attribute_value;
                    walletName = proofArray[k].proof_offer[3].attribute_value;
                  }
                }
              }
            }
            var userName = firstName + " " + lastName;
            userName = userName.trim() == ""?"Unknown":userName;
            companyName = companyName == ""?"Unknown":companyName;
            walletName = walletName == ""?"Unknown":walletName;
            genericDetail = {
              "title":"Proof Offer Detail",
              "subtitle":"",
              "data":[
                {
                  "name":"Message Id",
                  "value":responseData.data[index].message_id
                },
                {
                  "name":"Message Type",
                  "value":"New Proof Offer"
                }
              ]
            }
            genericDetail = {
              "title":"Proof Request Detail",
              "subtitle":"",
              "data":[
                {
                  "name":"Message Id",
                  "value":responseData.data[index].message_id
                },
                {
                  "name":"Message Type",
                  "value":"New Proof Request"
                }
              ]
            }
            var senderDid = responseData.data[index].message.sender_did;
            var indexProof = -1
            for(var j = 0; j < connectionArray.length; j++)
            {
              if(connectionArray[j].their_did == senderDid)
                indexProof = j;
            }
            if(indexProof > -1)
            {
              genericDetail.data.push(
                  {
                    "name":"User Name",
                    "value": userName
                  });
              genericDetail.data.push(
                  {
                    "name":"Company Name",
                    "value": companyName
                  });
              genericDetail.data.push(
                  {
                    "name":"Wallet Name",
                    "value": walletName
                  });
              genericDetail.data.push(
                  {
                    "name":"Sender DID",
                    "value": responseData.data[index].message.sender_did
                  });
            }
              genericDetail.data.push(
                  {
                    "name":"Proof Request Nonce",
                    "value": responseData.data[index].message.proof_request.nonce
                  });
              genericDetail.data.push(
                  {
                    "name":"Proof Request Name",
                    "value": responseData.data[index].message.proof_request.name
                  });
              genericDetail.data.push(
                  {
                    "name":"Proof Request Version",
                    "value": responseData.data[index].message.proof_request.version
                  });

              for(var a = 0; a < 1000; a++)
							{
								if(responseData.data[index].message.proof_request['requested_attributes'].hasOwnProperty("attr" + a + "_referent"))
								{		
                  var name = responseData.data[index].message.proof_request['requested_attributes']["attr" + a + "_referent"]['field'];
                  if(responseData.data[index].message.proof_request['requested_attributes']["attr" + a + "_referent"].hasOwnProperty("restrictions"))
                  { 
                    var credDefId = responseData.data[index].message.proof_request['requested_attributes']["attr" + a + "_referent"]["restrictions"][0]["cred_def_id"]
                    var schemaName = "";
                    for(var j = 0; j < responseData.data[index].message.mapping.length; j++)
                    {
                      if(responseData.data[index].message.mapping[j]["cred_def_id"] == credDefId)
                      {
                        schemaName = responseData.data[index].message.mapping[j]["schema_id"];
                      }
                    }
                    genericDetail.data.push(
                    {
                      "name":"Attribute " + a + " : " + name,
                      "value": "Request access to Schema: " + schemaName.split(":")[2] + "  Version: " + schemaName.split(":")[3]
                    });
                  }
                  else
                  {
                    genericDetail.data.push(
                    {
                      "name":"Attribute " + a + " : " + name,
                      "value": "User Input"
                    });
                  }
								}
							}
            for(var i = 0; i < responseData.data[index].message.proof_request.length; i++)
            {
              var finalName = responseData.data[index].message.proof_offer[i].attribute_name;
              if(responseData.data[index].message.proof_offer[i].attribute_schema_id != "")
                finalName += "    from " + responseData.data[index].message.proof_offer[i].attribute_schema_id.split(":")[2] + " (" + responseData.data[index].message.message.proof_offer[i].attribute_schema_id.split(":")[3] + ")"
              genericDetail.data.push(
                  {
                    "name":"Attribute: " + finalName,
                    "value": responseData.data[index].message.proof_offer[i].attribute_value
                  });
            }
            genericDetail.data.push(
                {
                  "name":"Datetime",
                  "value":dformat
                });
          }
          localStorage.generic_detail = JSON.stringify(genericDetail);
          window.open(genericDetailUrl, '_blank');
        }

        function viewDetail(index)
        {
          console.log(dataArray[index]);
          Swal.fire({
            title: 'Message',
            html: "<pre style='text-align:left'>" + JSON.stringify(dataArray[index], undefined, 2) + "</pre>",
            showCloseButton: true
          })
        }

        function deleteMessage(id)
        {          
          Swal.fire({
            title: 'Delete Message',
            text: "Confirm delete this message?",
            type: 'question',
          }).then((result) =>
          {
            if (result.value) {
              $("#loading-ajax").show();
              $.ajax({
                type: 'POST',
                url: deleteMessageUrl,
                contentType: "application/json",
                dataType: "json",
                processData: false,
                data:
                JSON.stringify({
                  token : localStorage.getItem("token") === null?"":localStorage.getItem("token"),
                  message_id: id
                }),
                headers: {
                  "Authorization": "Bearer " + apikey,
                },
                success: function(response)
                {
                  $("#loading-ajax").hide();
                  console.log(response)
                  var status = "";
                  var message = "";
                  var error = "";
                  if(response.hasOwnProperty("error"))
                    error = response.error;            
                  if(error != "")
                  {
                    Swal.fire(
                      response.error.type,
                      response.error.message,
                      'error'
                    );
                    return;
                  }
                  if(response.hasOwnProperty("status"))
                    status = response.status;
                  if(response.hasOwnProperty("message"))
                    message = response.message;
                  if(status === "200")
                  {
                    listMessage();
                  }
                }
              });
            }
          });
        }
        
        function createProofRequest(senderDid)
        {
            var jsonObject = 
            {
              "token" : localStorage.getItem("token") === null?"":localStorage.getItem("token"),
              "sender_did":senderDid,
              "proof_request":
              {
                "name":"ConnectionProfileExchange",
                "version":"1.0",
                "requested-attributes":[
                  {  
                      "field":"company_name",
                      "cred_def_id":oneIdCredDefId
                  },
                  {  
                      "field":"last_name",
                      "cred_def_id":oneIdCredDefId
                  },
                  {  
                      "field":"first_name",
                      "cred_def_id":oneIdCredDefId
                  },
                  {  
                      "field":"wallet_name",
                      "cred_def_id":""
                  }
                ]
              }
            };
            
            $("#loading-ajax").show();
            $.ajax({
              type: 'POST',
              url: createProofRequestUrl,
              contentType: "application/json",
              dataType: "json",
              processData: false,
              data:JSON.stringify(jsonObject),
              headers: {
                "Authorization": "Bearer " + apikey,
              },
              success: function(response)
              {
                $("#loading-ajax").hide();
                console.log(response)
                var status = "";
                var message = "";
                var error = "";
                if(response.hasOwnProperty("error"))
                  error = response.error;
                if(error != "")
                {
                  Swal.fire(
                    response.error.type,
                    response.error.message,
                    'error'
                  );
                  return;
                }
                if(response.hasOwnProperty("status"))
                  status = response.status;
                if(response.hasOwnProperty("message"))
                  message = response.message;
                if(status === "200")
                {
                  listMessage();
                }
              }
            });
          
        }

        function signOut()
        {
          $("#loading-ajax").show();
          $.ajax({
            type: 'POST',
            url: webSignOutUrl,
            contentType: "application/json",
            dataType: "json",
            processData: false,
            data:
            JSON.stringify({
              id : localStorage.getItem("sign_in_id") === null?"":localStorage.getItem("sign_in_id"),
              token : localStorage.getItem("token") === null?"":localStorage.getItem("token")
            }),
						headers: {
							"Authorization": "Bearer " + apikey,
						},
            success: function(response)
            {
              $("#loading-ajax").hide();
              console.log(response)
              var status = "";
              var message = "";
              var error = "";
              if(response.hasOwnProperty("error"))
                error = response.error;
              if(error != "")
              {
                Swal.fire(
                  response.error.type,
                  response.error.message,
                  'error'
                );
                return;
              }
              if(response.hasOwnProperty("status"))
                status = response.status;
              if(response.hasOwnProperty("message"))
                message = response.message;
              if(status === "200")
              {
                localStorage.clear();
                window.location.href = "/index.html";
              }
            }
          });
        }
        
        Number.prototype.padLeft = function(base,chr)
        {
          var  len = (String(base || 10).length - String(this).length)+1;
          return len > 0? new Array(len).join(chr || '0')+this : this;
        }
      </script>
  </body>
</html>